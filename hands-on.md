## 環境構築

### ハンズオン用ディレクトリの作成
HOST OS上の任意のディレクトリで`1day`ディレクトリを作成し、遷移しましょう。以降`1day`ディレクトリをカレントディレクトリとします。

```
$ mkdir 1day
$ cd 1day
```

### Vagrant設定ファイル(Vagrantfile)の作成
`Vagrantfile`が作成されること

```
$ vagrant init
$ ls -la
-rw-r--r--   1 miurahironori  staff  3008  9  7 17:24 Vagrantfile
```

### boxファイルの配布
インターネットからDLするとそれなりのサイズのため、ネットワーク環境に不安がある場合に限り、事前に渡したUSBの中にある　`centos/7`ディレクトリを指定したディレクトリにコピーしましょう

`~/.vagrant.d/boxes` ボックスファイルが格納されるディレクトリ    
`vagrant box list` ローカルで利用可能なボックスのリスト表示。今回`centos/7           (virtualbox, 1905.1)`が初回に表示されないこと    

```
$ vagrant box list

$ cp -R /Volumes/NO\ NAME/centos-VAGRANTSLASH-7 ~/.vagrant.d/boxes/.
$ vagrant box list
centos/7           (virtualbox, 1905.1)
```

### 設定ファイル編集
カレントディレクトリで`Vagrantfile`を以下の内容で編集しましょう
boxファイル`puppetlabs/centos-7.2-64-nocm`、IPアドレス `192.168.56.33`、VirtualBoxでのマシン名 `1day`、メモリ `768M`で設定

```
$ vi Vagrantfile
$ cat Vagrantfile
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
  config.vm.hostname = "1day.local"
  config.vm.network :private_network, ip: "192.168.56.50"
  config.vm.provider :virtualbox do |vb|
    vb.name = "1day"
    vb.customize ["modifyvm", :id, "--memory", "768"]
  end
end
```

### Vagrantによる仮想環境の起動(初回の作成)
`not created (virtualbox)`から`running (virtualbox)`となること

```
$ vagrant status
Current machine states:

default                   not created (virtualbox)

$ vagrant up

$ vagrant status
Current machine states:

default                   running (virtualbox)
```

### ssh-configの確認
今回のVagrant環境に接続する際の設定を確認する

```
$ vagrant ssh-config
Host default
  HostName 127.0.0.1
  User vagrant
  Port 2200
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /Users/miurahironori/Vagrant/1/.vagrant/machines/default/virtualbox/private_key
  IdentitiesOnly yes
  LogLevel FATAL
```
### VirtualBoxでの確認
VirtualBoxのGUIコンソールで`1day`と言う仮想サーバが存在し「実行中」となっていることを確認する

### 接続とrootユーザ遷移
`vagrant ssh`にて仮想環境に`vagrant`ユーザでログインし`root`まで遷移できることを確認する

```
$ vagrant ssh
[vagrant@1day ~]$ who
vagrant  pts/0        2017-09-14 01:41 (10.0.2.2)
[vagrant@1day ~]$ sudo su -
最終ログイン: 2017/09/14 (木) 01:41:14 UTC 192.168.56.1から開始日時 pts/0
[root@1day ~]#
```

## 設定内容の確認
`enp0s8`に`Vagrantfile`で設定したIP`192.168.56.33`が設定されていること。デフォルトルータ`10.0.2.2`、DNSサーバ`10.0.2.3`についても確認する

```
[root@1day ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 08:00:27:b7:f3:af brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
       valid_lft 63945sec preferred_lft 63945sec
    inet6 fe80::a00:27ff:feb7:f3af/64 scope link
       valid_lft forever preferred_lft forever
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 08:00:27:27:cb:87 brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.33/24 brd 192.168.56.255 scope global enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe27:cb87/64 scope link
       valid_lft forever preferred_lft forever

[root@1day ~]# ip r
default via 10.0.2.2 dev enp0s3  proto static  metric 100
10.0.2.0/24 dev enp0s3  proto kernel  scope link  src 10.0.2.15  metric 100
169.254.0.0/16 dev enp0s8  scope link  metric 1003
192.168.56.0/24 dev enp0s8  proto kernel  scope link  src 192.168.56.33

[root@1day ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search hq-nw-qc.voyagegroup.local local
nameserver 10.0.2.3
```

`Mem:        758812`にて約768M確保されていることを確認

```
[root@1day ~]# free
              total        used        free      shared  buff/cache   available
Mem:         758812       89916      534236        5324      134660      549976
Swap:       1048572           0     1048572

[root@1day ~]# cat /proc/meminfo
MemTotal:         758812 kB
MemFree:          534236 kB
MemAvailable:     549996 kB
Buffers:             948 kB
Cached:           105660 kB
SwapCached:            0 kB
Active:           101816 kB
Inactive:          68732 kB
Active(anon):      64092 kB
Inactive(anon):     5172 kB
Active(file):      37724 kB
Inactive(file):    63560 kB
Unevictable:           0 kB
Mlocked:               0 kB
SwapTotal:       1048572 kB
SwapFree:        1048572 kB
Dirty:                 0 kB
Writeback:             0 kB
AnonPages:         63972 kB
Mapped:            22472 kB
Shmem:              5324 kB
Slab:              28072 kB
SReclaimable:      16904 kB
SUnreclaim:        11168 kB
KernelStack:        1840 kB
PageTables:         4380 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:     1427976 kB
Committed_AS:     333512 kB
VmallocTotal:   34359738367 kB
VmallocUsed:        9856 kB
VmallocChunk:   34359719420 kB
HardwareCorrupted:     0 kB
AnonHugePages:      4096 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:       51136 kB
DirectMap2M:      735232 kB
```
**Q.CPU数、Disk容量はいくつか調べてみましょう。(5分)**

#### 補足
直接rootでログインする場合(ただしこのインターンでは`vagrant ssh`で接続した前提で進める)  
パスワードは`puppet`

```
$ ssh root@192.168.56.33
root@192.168.56.33's password:
[root@1day ~]# exit
ログアウト
```

#### エディタのインストール
今後作業する上で使い慣れたエディタが良い人は必須ではありませんがインストールを行いましょう

- vim
```
# yum install -y vim
```

- emacs
```
# yum install -y emacs
```

### Git
Re:Dashの設定ファイルをクローンするため、gitのインストールを行いましょう
```
# yum install -y git
# git --version
git version 1.8.3.1
```

### Docker&Docker-compose
MySQL、Re:dashをdockerで利用するため、dockerのインストール、起動を行いましょう
```
# yum install -y docker
# systemctl start docker
# docker version
Client:
 Version:         1.12.6
 API version:     1.24
 Package version: docker-1.12.6-48.git0fdc778.el7.centos.x86_64
 Go version:      go1.8.3
 Git commit:      0fdc778/1.12.6
 Built:           Thu Sep  7 18:00:07 2017
 OS/Arch:         linux/amd64

Server:
 Version:         1.12.6
 API version:     1.24
 Package version: docker-1.12.6-48.git0fdc778.el7.centos.x86_64
 Go version:      go1.8.3
 Git commit:      0fdc778/1.12.6
 Built:           Thu Sep  7 18:00:07 2017
 OS/Arch:         linux/amd64
```
docker-composeのインストール
```
# curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
# chmod +x /usr/local/bin/docker-compose
# docker-compose -version
docker-compose version 1.16.1, build 6d1ac21
```

### PORTの設定
今回のミドルウェアで外部からアクセスさせるPORTの80,3306,5000を解放しましょう

#### 確認
[参考 redhat:4.5.1. firewalld の概要](https://access.redhat.com/documentation/ja-JP/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html)

```
# firewall-cmd --list-all
public (default, active)
  interfaces: enp0s3 enp0s8
  sources:
  services: dhcpv6-client ssh
  ports:
  masquerade: no
  forward-ports:
  icmp-blocks:
  rich rules:
```

#### ポートの解放
```
# firewall-cmd --add-service=http --permanent
# firewall-cmd --permanent --add-port=3306/tcp
# firewall-cmd --permanent --add-port=5000/tcp
# firewall-cmd --reload
```

#### 確認
```
# firewall-cmd --list-all
public (default, active)
  interfaces: enp0s3 enp0s8
  sources:
  services: dhcpv6-client http ssh
  ports: 3306/tcp 5000/tcp
  masquerade: no
  forward-ports:
  icmp-blocks:
  rich rules:
```

### 起動shellの作成
ここまで作成した環境をshellにおこし、Vagrantを初回起動した際に自動で作成できるようにしましょう

#### vagrantのおさらい

起動(初回時のみVagrantfileを反映、以降はオプション指定が必要)
```
$ vagrant up
```

接続
```
$ vagrant ssh
```

停止
```
$ vagrant halt
```

破棄
```
$ vagrant destroy
```

#### Vagrantfileの変更
Vagrantfile内でシェルスクリプトの呼び出しを記載します

```
$ vi Vagrantfile
11-12行目の間に
+ config.vm.provision :shell, :path => "bootstrap.sh"
```
Vagrantfileに追記したbootstrap.shを作成します
```
$ vi bootstrap.sh
$ cat bootstrap.sh
yum install -y git
yum install -y docker
systemctl start docker
yum install -y vim
yum install -y emacs
curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
firewall-cmd --add-service=http --permanent
firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --permanent --add-port=5000/tcp
firewall-cmd --reload
```
#### 再構築
現在のvagrant環境を破棄し再作成しましょう

破棄
```
$ vagrant destroy
```

確認
```
$ vagrant status
Current machine states:

default                   not created (virtualbox)
```

作成
```
$ vagrant up
```

確認
```
$ vagrant status
Current machine states:

default                   running (virtualbox)
```

余談
`/Users/miurahironori/Vagrant/1day`は任意のパス(みなさんが今回1day用に作成したパス)、`-p 2200`も`vagrant ssh-config`で出力されたポートフォワード用のポートになります

```
$ ssh -i /Users/miurahironori/Vagrant/1day/.vagrant/machines/default/virtualbox/private_key -o StrictHostKeyChecking=no -o PasswordAuthentication=no -p 2200 vagrant@127.0.0.1
```

#### 確認
各ミドルウェアがインストールされているか今回はバージョンの出力でコマンドラインから確認し、起動確認はsystemctlで確認しましょう
```
# docker -v
Docker version 1.12.6, build 0fdc778/1.12.6
# docker-compose version
docker-compose version 1.16.1, build 6d1ac21
docker-py version: 2.5.1
CPython version: 2.7.13
OpenSSL version: OpenSSL 1.0.1t  3 May 2016

# git --version
git version 1.8.3.1

# systemctl status docker
● docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled)
   Active: active (running) since Thu 2017-09-14 09:01:57 UTC; 2min 9s ago
     Docs: http://docs.docker.com
 Main PID: 6427 (dockerd-current)
   CGroup: /system.slice/docker.service
           ├─6427 /usr/bin/dockerd-current --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current --default-runtime=docker-runc --exec-opt native.cgroupdriver=systemd --userla...
           └─6432 /usr/bin/docker-containerd-current -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --shim docker-containerd-shim --metrics-interval=0 --start-timeout 2m ...

Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.285985382Z" level=info msg="Graph migration to content-addressability took 0.00 seconds"
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.286219153Z" level=warning msg="mountpoint for pids not found"
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.286363671Z" level=info msg="Loading containers: start."
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.298511181Z" level=info msg="Firewalld running: true"
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.428360733Z" level=info msg="Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. ...IP address"
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.528733860Z" level=info msg="Loading containers: done."
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.528816184Z" level=info msg="Daemon has completed initialization"
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.528828382Z" level=info msg="Docker daemon" commit="0fdc778/1.12.6" graphdriver=devicemapper version=1.12.6
Sep 14 09:01:57 1day.local systemd[1]: Started Docker Application Container Engine.
Sep 14 09:01:57 1day.local dockerd-current[6427]: time="2017-09-14T09:01:57.546709417Z" level=info msg="API listen on /var/run/docker.sock"
Hint: Some lines were ellipsized, use -l to show in full.
```

### Question
設定したポートが利用可能かどうか確認しましょう。これまでのオペレーションで確認コマンドは実行しています

### MySQL(Docker)
今回MySQL環境はCentOS環境に直接インストールせずDockerイメージを利用します

#### イメージのpull
MySQLのdockerイメージをpullします

確認
```
# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
```

MySQL imageのpull
```
# docker pull mysql
Using default tag: latest
Trying to pull repository docker.io/library/mysql ...
latest: Pulling from docker.io/library/mysql
aa18ad1a0d33: Pull complete
1324423d52e9: Pull complete
ee152a81987c: Pull complete
b054cf37bcae: Pull complete
eb0cbad90353: Pull complete
710fc2dae571: Pull complete
5ff098d10285: Pull complete
79f9dfa6f98f: Pull complete
5d033d38431e: Pull complete
bdde10ea566e: Pull complete
1a36bb8deb0e: Pull complete
Digest: sha256:dfaabbd5466dafe04c5af0ccb1a43d8a18a9604ac23a95534bb0626b3321034d
```

確認
```
# docker images
REPOSITORY                TAG                 IMAGE ID            CREATED             SIZE
docker.io/mysql           latest              aeaed9976244        41 hours ago        412.3 MB
```
#### コンテナの起動と確認
MySQLイメージから`MYSQL_ROOT_PASSWORD=mysql`にてパスワードを設定しコンテナを起動します。今回はポートフォワードを3306から3306で行います。docker run後docker psでコンテナが立ち上がってることを確認しましょう

確認
```
# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
```

コンテナ起動
```
# docker run --name mysqld -e MYSQL_ROOT_PASSWORD=mysql -d -p 3306:3306 mysql
```

確認(CONTAINER IDは重要)
```
# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
54caa9126c32        mysql               "docker-entrypoint.sh"   4 seconds ago       Up 3 seconds        3306/tcp            mysqld
```

#### bashモードで接続
コンテナに直接接続します。`docker ps`にて出力された**`CONTAINER ID`**を指定しましょう。
```
# docker exec -it 54caa9126c32 bash

root@54caa9126c32:/# ★に接続(以下プロンプトは消去

# mysql -u root -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 4
Server version: 5.7.19 MySQL Community Server (GPL)

Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
mysql> exit;
Bye
# exit
exit
#
```

#### MySQLクライアントの導入
GUEST OS(CentOS)上からMySQLコマンドを実行してみましょう。クライアントが存在しないのでエラーになるはずです。MySQL dockerコンテナにGUESTから接続できるよう設定していきます。

確認
```
# mysql -u root -p
-bash: mysql: command not found
```

クライアントをインストールします(クライアントが存在するmysqlサーバリポジトリをインストール)
```
# yum install -y mysql
```

MySQLコンテナのipアドレスの確認 その１  
`inet 172.17.0.2`を確認。ただし`ip`コマンドが使用できない場合は割愛し、その２を行う。
```
# docker exec -it 54caa9126c32 bash
root@54caa9126c32:/# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
5: eth0@if6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:acff:fe11:2/64 scope link
       valid_lft forever preferred_lft forever
root@54caa9126c32:/# exit
exit
```

MySQLコンテナのipアドレスの確認 その2  
`"IPv4Address": "172.17.0.2/16",`を確認
```
# docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "17df6c9580e6c2b6c6458b0a7a4136cdb288744c9bf96954c1344cf7fb1c2650",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16"
                }
            ]
        },
        "Internal": false,
        "Containers": {
            "ae3ee5732057705518f78def29ddad4f26ca1f19185d336c042b91b8a5a04b0a": {
                "Name": "mysqld",
                "EndpointID": "d1212cb09110e81c0a887d85996cb937dabfa1bb83f63bd5d7eb4022026d4c88",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
```

確認したIPで接続
```
# mysql -u root -p -h172.17.0.2
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.7.19 MySQL Community Server (GPL)

Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]>
MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)

MySQL [(none)]> exit
Bye
```

ループバックアドレスでも可能
```
# mysql -u root -p -h127.0.0.1
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.7.19 MySQL Community Server (GPL)

Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]>
```

